<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bildst√∂d ‚Äì Dagsplanerare</title>
  <style>
    :root{
      /* Light theme colors */
      --bg: #ffffff;
      --panel: #ffffff;
      --panel-2: #fafafa;
      --card: #ffffff;
      --card-done: #e0ffe0;
      --text: #111827;
      --muted: #6b7280;
      --accent: #22c55e;
      --accent-2: #60a5fa;
      --warn: #f59e0b;
      --danger: #ef4444;
      --ring: rgba(96,165,250,0.8);
      --radius: 18px;
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    header{
      position: sticky; top:0; z-index:10;
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(250,250,250,0.9));
      border-bottom: 1px solid rgba(148,163,184,0.15);
      padding: 10px 12px;
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    header .title{
      font-weight: 800;
      letter-spacing: 0.3px;
      font-size: 18px;
      margin-right: auto;
      display:flex; align-items:center; gap:8px;
    }
    header .pill{
      font-size: 12px; color: var(--muted);
      background: rgba(148,163,184,0.12);
      padding: 4px 8px; border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.2);
    }

    .btn{
      border: 1px solid rgba(148,163,184,0.25);
      background: var(--panel);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.15s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(96,165,250,0.6); }
    .btn:active{ transform: translateY(0); }
    .btn.primary{ background: rgba(34,197,94,0.15); border-color: rgba(34,197,94,0.6); }
    .btn.blue{ background: rgba(96,165,250,0.12); border-color: rgba(96,165,250,0.55); }
    .btn.warn{ background: rgba(245,158,11,0.12); border-color: rgba(245,158,11,0.55); }
    .btn.danger{ background: rgba(239,68,68,0.12); border-color: rgba(239,68,68,0.55); }

    main{
      padding: 12px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      max-width: 1000px;
      margin: 0 auto;
    }

    /* People row */
    .people{
      background: var(--panel);
      border: 1px solid rgba(148,163,184,0.18);
      border-radius: var(--radius);
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .people-header{ display:flex; align-items:center; gap:8px; padding: 6px; border-bottom: 1px dashed rgba(148,163,184,0.18); }
    .people-title{ font-weight: 800; font-size: 18px; }
    .people-actions{ margin-left:auto; display:flex; gap:6px; }
    .people-list{ display:grid; grid-template-columns: repeat(auto-fill, minmax(210px, 1fr)); gap:10px; padding:8px 6px; }
    .person{
      display:flex; flex-direction:column; gap:8px;
      border: 2px solid rgba(148,163,184,0.18);
      border-radius: 16px; padding: 10px;
      background: var(--panel-2);
      cursor: default;
      min-height: 86px;
      position: relative;
    }
    .person.edit{ cursor: pointer; }
    .person-name{ font-weight: 800; }
    .person-status{ font-size: 12px; font-weight: 800; color: var(--muted); }
    .person-meta{ font-size: 12px; color: var(--muted); }
    .person-controls{ display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
      /* Calm child mode: reduce hover lift */
      body:not(.edit-on) .card:hover{ transform:none; }
      body:not(.edit-on) .btn:hover{ transform:none; }
      /* More air in people list (kept via grid gap above) */
    .person-select{ padding:8px; border-radius:10px; border:1px solid rgba(148,163,184,0.25); background: var(--panel); font-weight:700; }
    .person-input{ padding:8px; border-radius:10px; border:1px solid rgba(148,163,184,0.25); background: var(--panel-2); font-weight:700; }
    .person-chip{ padding:6px 8px; border-radius:999px; border:1px solid rgba(148,163,184,0.25); background: rgba(148,163,184,0.08); font-weight:700; cursor:pointer; }
    .person-chip:hover{ border-color: rgba(96,165,250,0.6); }

    .slot{
      background: var(--panel);
      border: 1px solid rgba(148,163,184,0.18);
      border-radius: var(--radius);
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .slot-header{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      padding: 6px 6px 10px 6px;
      border-bottom: 1px dashed rgba(148,163,184,0.18);
    }
    .slot-title{
      font-weight: 800; font-size: 18px;
      letter-spacing: 0.2px;
      display:flex; align-items:center; gap:8px;
    }
    .slot-sub{
      font-size: 12px; color: var(--muted);
      margin-left: 4px;
    }
    .slot-actions{ margin-left:auto; display:flex; gap:6px; }

    .cards{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
      gap: 10px;
      margin-top: 10px;
      min-height: 48px;
    }

    .card{
      background: var(--card);
      border: 2px solid rgba(148,163,184,0.18);
      border-radius: 16px;
      padding: 10px;
      display:flex; gap:10px; align-items:center;
      min-height: 86px;
      position: relative;
      cursor: pointer;
      transition: 0.12s ease;
      outline:none;
    }
    .card:hover{ border-color: rgba(96,165,250,0.6); transform: translateY(-1px); }
    .card:focus-visible{ box-shadow: 0 0 0 4px var(--ring); }
    .card.done{
      background: var(--card-done);
      border-color: rgba(34,197,94,0.6);
      opacity: 0.92;
    }
    .card.now{
      border-color: rgba(96,165,250,0.9);
      box-shadow: 0 0 0 3px rgba(96,165,250,0.35);
    }

    .icon{
      width: 64px; height: 64px; flex: 0 0 64px;
      border-radius: 12px;
      background: rgba(148,163,184,0.08);
      display:grid; place-items:center;
      font-size: 36px;
      border: 1px solid rgba(148,163,184,0.18);
    }

    .card-text{
      display:flex; flex-direction:column; gap:4px;
      width: 100%;
    }
    .label{
      font-size: 18px; font-weight: 800; line-height: 1.2;
    }
    .time{
      font-size: 13px; color: var(--muted);
      font-weight: 700;
      letter-spacing: 0.3px;
    }

    .badge{
      position:absolute; top:8px; right:8px;
      font-size: 11px; font-weight: 800;
      padding: 4px 6px; border-radius: 999px;
      background: rgba(99,102,241,0.15);
      color: #c7d2fe;
      border: 1px solid rgba(99,102,241,0.45);
    }
    .badge.done{
      background: rgba(34,197,94,0.12);
      color: #bbf7d0;
      border-color: rgba(34,197,94,0.55);
    }

    .drag-handle{
      position:absolute; bottom:6px; right:6px;
      font-size: 12px; color: var(--muted);
      opacity: 0.7;
      display:none;
    }
    .edit-on .drag-handle{ display:block; }

    .empty{
      border: 2px dashed rgba(148,163,184,0.25);
      border-radius: 14px;
      padding: 12px;
      color: var(--muted);
      text-align:center;
      font-size: 14px; font-weight: 700;
    }

    /* Modal */
    .modal-backdrop{
      position: fixed; inset:0; background: rgba(0,0,0,0.6);
      display:none; place-items:center; z-index:100;
      padding: 12px;
    }
    .modal-backdrop.show{ display:grid; }
    .modal{
      width: 100%; max-width: 520px;
      background: var(--panel);
      border: 1px solid rgba(148,163,184,0.2);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
    }
    .modal h2{
      margin: 6px 4px 10px;
      font-size: 20px;
    }
    .modal .row{
      display:grid; grid-template-columns: 1fr 1fr; gap:8px;
      margin-bottom: 8px;
    }
    .modal label{
      font-size: 12px; font-weight: 800; color: var(--muted);
      margin: 2px 2px 4px; display:block;
    }
    .modal input, .modal select{
      width:100%;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.25);
      background: var(--panel-2);
      color: var(--text);
      font-size: 16px; font-weight: 700;
      outline:none;
    }

    .library{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap:8px; max-height: 260px; overflow:auto;
      padding: 6px; background: var(--panel-2);
      border-radius: 12px; border: 1px solid rgba(148,163,184,0.18);
    }
    .lib-item{
      background: rgba(148,163,184,0.06);
      border: 1px solid rgba(148,163,184,0.18);
      border-radius: 12px; padding: 8px;
      display:flex; flex-direction:column; align-items:center; gap:6px;
      cursor:pointer; transition:0.1s ease;
      text-align:center;
    }
    .lib-item:hover{ border-color: rgba(96,165,250,0.6); transform: translateY(-1px); }
    .lib-emoji{ font-size: 30px; }
    .lib-label{ font-size: 12px; font-weight: 800; color: var(--text); }

    .modal-actions{
      display:flex; gap:8px; justify-content:flex-end; margin-top: 10px;
    }

    footer{
      opacity:0.8; color: var(--muted); font-size: 12px;
      padding: 10px 12px; text-align:center;
    }

    @media (min-width: 720px){
      header .title{ font-size: 20px; }
      .slot-title{ font-size: 20px; }
      .label{ font-size: 20px; }
      .icon{ width: 72px; height: 72px; font-size: 40px; }
      .card{ min-height: 96px; }
    }
  </style>
</head>
<body>
<header>
  <div class="title">
    <span style="font-size:22px;">üß©</span>
    Bildst√∂d ‚Äì Dagsplanerare
    <span class="pill" id="modePill">Barnl√§ge</span>
  </div>

  <button class="btn blue" id="toggleModeBtn" aria-label="V√§xla vuxen/barnl√§ge">üîí L√•s upp (vuxenl√§ge)</button>
  <button class="btn" id="toggleTimesBtn" aria-label="Visa eller d√∂lj tider">üïí Visa tider</button>
  <button class="btn warn" id="resetDoneBtn" aria-label="Nollst√§ll klarmarkeringar och rensa kort">‚Ü∫ Nollst√§ll & Rensa</button>
  <button class="btn" id="exportBtn" aria-label="Exportera dag som fil">‚¨áÔ∏è Exportera</button>
  <label class="btn" for="importInput" style="cursor:pointer;">‚¨ÜÔ∏è Importera</label>
  <input id="importInput" type="file" accept="application/json" style="display:none;" />
</header>

<main id="board"></main>

<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <h2 id="modalTitle">L√§gg till aktivitet</h2>

    <div class="row">
      <div>
        <label for="activityText">Text (kort och tydlig)</label>
        <input id="activityText" placeholder="t.ex. Frukost" />
      </div>
      <div>
        <label for="activityTime">Tid (valfritt)</label>
        <input id="activityTime" placeholder="t.ex. 09:30" />
      </div>
    </div>

    <label>V√§lj bild (tryck p√• en ikon)</label>
    <div class="library" id="library"></div>

    <input id="activityEmoji" type="hidden" />

    <div class="modal-actions">
      <button class="btn" id="cancelBtn">Avbryt</button>
      <button class="btn danger" id="deleteBtn" style="display:none;">Ta bort</button>
      <button class="btn primary" id="saveBtn">Spara</button>
    </div>
  </div>
</div>

<!-- (people modal borttagen ‚Äì inline-redigering anv√§nds) -->

<footer>
  Lokal lagring i webbl√§saren. Ingen inloggning. Inget data l√§mnar enheten.
</footer>

<script>
/* =========================================================
   Bildst√∂d ‚Äì Dagsplanerare (frontend-only)
   Designad f√∂r barn med NPF: f√• val, stora ytor, stabil layout.
   ========================================================= */

// Fast slots (enkelt f√∂r barnet)
const DEFAULT_SLOTS = [
  { key: "morning",  label: "Morgon",      hint: "Start och rutiner" },
  { key: "forenoon", label: "F√∂rmiddag",  hint: "Fokus/Skola" },
  { key: "lunch",    label: "Lunch",      hint: "Mat och paus" },
  { key: "afternoon",label: "Eftermiddag",hint: "Aktivitet/lek" },
  { key: "evening",  label: "Kv√§ll",      hint: "Varva ner och sova" }
];

// Lugn, igenk√§nnbar startbank av pictos (emoji som placeholder)
const LIBRARY = [
  {emoji:"üåÖ", text:"Vakna"}, {emoji:"üçû", text:"Frukost"}, {emoji:"üß•", text:"Kl√§ p√• sig"},
  {emoji:"ü™•", text:"Borsta t√§nder"}, {emoji:"üíá", text:"Borsta h√•ret"}, {emoji:"üöó", text:"√Öka"},
  {emoji:"üè´", text:"Skola"}, {emoji:"üìö", text:"L√§sa"}, {emoji:"‚úèÔ∏è", text:"Skola/Arbete"},
  {emoji:"ü•™", text:"Mellis"}, {emoji:"üç≤", text:"Lunch"}, {emoji:"üçù", text:"Middag"},
  {emoji:"üå≥", text:"Ute"}, {emoji:"‚öΩ", text:"Lek ute"}, {emoji:"üé®", text:"Rita"},
  {emoji:"üß±", text:"Bygga"}, {emoji:"üé≤", text:"Spel"}, {emoji:"üì∫", text:"Sk√§rmtid"},
  {emoji:"üö≤", text:"Cykla"}, {emoji:"üßò", text:"Vila"}, {emoji:"üìñ", text:"Bok"},
  {emoji:"üõÅ", text:"Bada"}, {emoji:"üò¥", text:"Sova"}, {emoji:"üíä", text:"Medicin"},
  {emoji:"üéµ", text:"Musik"}, {emoji:"ü§∏", text:"R√∂relse"}, {emoji:"üßπ", text:"St√§da"},
  // Till√§gg enligt √∂nskem√•l
  {emoji:"üê¥", text:"H√§st"},
  {emoji:"üíª", text:"Dator"},
  {emoji:"üßë‚Äçü§ù‚Äçüßë", text:"Kompisar"},
  {emoji:"üëß", text:"Syskon tjej"},
  {emoji:"üë¶", text:"Syskon kille"},
  {emoji:"üë©", text:"Mamma"},
  {emoji:"üë®", text:"Pappa"},
  {emoji:"üëµ", text:"Mormor"},
];

const STORAGE_KEY = "bildstod_plan_v1";

// Safe UUID helper (fallback if crypto.randomUUID is unavailable)
function safeUUID(){
  try{
    if (window.crypto && typeof window.crypto.randomUUID === 'function'){
      return window.crypto.randomUUID();
    }
  }catch(e){}
  return 'id-' + Date.now().toString(36) + Math.random().toString(36).slice(2);
}

// ----- State -----
let state = loadState() || makeDefaultState();
let editMode = false;       // Barnl√§ge default
let showTimes = false;
let editingContext = null;  // {slotKey, itemId}

// ----- Init -----
const boardEl = document.getElementById("board");
const modePill = document.getElementById("modePill");
const toggleModeBtn = document.getElementById("toggleModeBtn");
const toggleTimesBtn = document.getElementById("toggleTimesBtn");
const resetDoneBtn = document.getElementById("resetDoneBtn");
const exportBtn = document.getElementById("exportBtn");
const importInput = document.getElementById("importInput");

const modalBackdrop = document.getElementById("modalBackdrop");
const modalTitle = document.getElementById("modalTitle");
const activityText = document.getElementById("activityText");
const activityTime = document.getElementById("activityTime");
const activityEmoji = document.getElementById("activityEmoji");
const libraryEl = document.getElementById("library");
const cancelBtn = document.getElementById("cancelBtn");
const saveBtn = document.getElementById("saveBtn");
const deleteBtn = document.getElementById("deleteBtn");

// People (inline only)
let editingPersonId = null; // not used for modal anymore
let addingPerson = false;
// Helper to get simple time options
const TIME_OPTS = ["","08:00","10:00","12:00","14:00","15:00","16:00","18:00","20:00"];

renderLibrary();
render();

toggleModeBtn.addEventListener("click", () => {
  editMode = !editMode;
  modePill.textContent = editMode ? "Vuxenl√§ge" : "Barnl√§ge";
  toggleModeBtn.textContent = editMode ? "üîì L√•s (barnl√§ge)" : "üîí L√•s upp (vuxenl√§ge)";
  document.body.classList.toggle("edit-on", editMode);
  render();
});

toggleTimesBtn.addEventListener("click", () => {
  showTimes = !showTimes;
  toggleTimesBtn.textContent = showTimes ? "üïí D√∂lj tider" : "üïí Visa tider";
  render();
});

resetDoneBtn.addEventListener("click", () => {
  if (!confirm("Nollst√§lla KLAR och rensa alla kort?")) return;
  // Clear done flags first (for safety if items remain)
  for (const slot of state.slots){
    for (const id of slot.items){
      state.items[id].done = false;
    }
  }
  // Then clear all cards
  for (const slot of state.slots){
    slot.items = [];
  }
  state.items = {};
  saveState();
  render();
});

exportBtn.addEventListener("click", () => {
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `bildstod-${state.id}.json`;
  a.click();
  URL.revokeObjectURL(url);
});

importInput.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  try{
    const text = await file.text();
    const imported = JSON.parse(text);
    if (imported && imported.slots && imported.items){
      state = imported;
      saveState();
      render();
    } else {
      alert("Filen s√•g inte ut som en dagsplan.");
    }
  }catch(err){
    alert("Kunde inte l√§sa filen.");
  } finally {
    importInput.value = "";
  }
});

// Modal events
cancelBtn.addEventListener("click", closeModal);
modalBackdrop.addEventListener("click", (e)=> {
  if (e.target === modalBackdrop) closeModal();
});

// (modal events borttagna)

saveBtn.addEventListener("click", () => {
  const text = activityText.value.trim();
  const time = activityTime.value.trim();
  const emoji = activityEmoji.value || "üü¶";

  if (!text){
    activityText.focus();
    return;
  }

  if (editingContext?.itemId){
    // Update existing
    const item = state.items[editingContext.itemId];
    item.text = text;
    item.time = time;
    item.emoji = emoji;
  } else if (editingContext?.slotKey){
    // Add new
    const id = safeUUID();
    state.items[id] = { id, text, time, emoji, done:false };
    const slot = state.slots.find(s=>s.key===editingContext.slotKey);
    slot.items.push(id);
  }

  saveState();
  closeModal();
  render();
});

deleteBtn.addEventListener("click", () => {
  if (!editingContext?.itemId) return;
  const {slotKey, itemId} = editingContext;
  const slot = state.slots.find(s=>s.key===slotKey);
  slot.items = slot.items.filter(id=>id!==itemId);
  delete state.items[itemId];
  saveState();
  closeModal();
  render();
});

// ----- Rendering -----
function render(){
  boardEl.innerHTML = "";
  // People section first
  const peopleEl = document.createElement("section");
  peopleEl.className = "people";
  const ph = document.createElement("div"); ph.className = "people-header";
  const pt = document.createElement("div"); pt.className = "people-title"; pt.textContent = "Idag √§r jag med";
  ph.appendChild(pt);
  const pa = document.createElement("div"); pa.className = "people-actions";
  if (editMode){
    const addPersonBtn = document.createElement("button");
    addPersonBtn.className = "btn blue";
    addPersonBtn.textContent = "Ôºã L√§gg till";
    addPersonBtn.addEventListener("click", ()=> openPeopleAddModal());
    pa.appendChild(addPersonBtn);
  }
  ph.appendChild(pa);
  peopleEl.appendChild(ph);
  const pl = document.createElement("div"); pl.className = "people-list";
  for (const person of state.people || []){
    const p = document.createElement("div");
    p.className = "person" + (editMode ? " edit" : "");
    p.dataset.personId = person.id;
    if (editMode){ p.title = "Redigera med kontroller"; }
    const nameEl = document.createElement("div"); nameEl.className = "person-name"; nameEl.textContent = person.name;
    // Inline delete icon on person card (edit mode)
    if (editMode){
      const delIcon = document.createElement("button");
      delIcon.type = "button";
      delIcon.className = "btn danger";
      delIcon.style.position = "absolute";
      delIcon.style.top = "6px";
      delIcon.style.left = "6px";
      delIcon.style.padding = "4px 6px";
      delIcon.style.fontSize = "12px";
      delIcon.textContent = "üóëÔ∏è";
      delIcon.title = "Ta bort person";
      delIcon.addEventListener("click", (e)=>{
        e.stopPropagation();
        if (!confirm(`Ta bort ${person.name}?`)) return;
        if (!person.id){
          const idx = (state.people || []).indexOf(person);
          if (idx >= 0){ (state.people || []).splice(idx,1); }
        } else {
          state.people = (state.people || []).filter(p=>p.id!==person.id);
        }
        saveState();
        render();
      });
      p.appendChild(delIcon);
    }
    const statusEl = document.createElement("div"); statusEl.className = "person-status"; statusEl.textContent = statusLabel(person.status);
    const metaEl = document.createElement("div"); metaEl.className = "person-meta";
    const parts = [];
    if (person.withWho) parts.push("med " + person.withWho);
    if (person.withWhatText) parts.push(person.withWhatEmoji ? person.withWhatEmoji + " " + person.withWhatText : person.withWhatText);
    if (person.etaStart && person.etaEnd){ parts.push("mellan " + person.etaStart + " - " + person.etaEnd); }
    else if (person.eta){ parts.push("kommer ca " + person.eta); }
    metaEl.textContent = parts.join(" ¬∑ ");
    p.appendChild(nameEl);
    p.appendChild(statusEl);
    if (parts.length) p.appendChild(metaEl);

    // Inline controls (adult mode)
    if (editMode){
      const controls = document.createElement("div");
      controls.className = "person-controls";

      // Status select
      const statusSel = document.createElement("select");
      statusSel.className = "person-select";
      for (const opt of [{v:"here",l:"‚úÖ h√§r"},{v:"away",l:"üöó borta"},{v:"later",l:"‚è≥ senare"}]){
        const o = document.createElement("option"); o.value = opt.v; o.textContent = opt.l; if (person.status===opt.v) o.selected = true; statusSel.appendChild(o);
      }
      statusSel.addEventListener("change", ()=>{ person.status = statusSel.value; saveState(); render(); });
      controls.appendChild(statusSel);

      // WithWho select + free text
      const withSel = document.createElement("select");
      withSel.className = "person-select";
      const withOptions = ["Mamma","Pappa","Syskon","Kompis","L√§rare","Assistent","Ingen","Annan‚Ä¶"];
      for (const label of withOptions){
        const o = document.createElement("option"); o.value = label; o.textContent = label; withSel.appendChild(o);
      }
      // Stable custom logic
      person.withCustom = person.withCustom === true || (person.withWho && !withOptions.includes(person.withWho));
      const withInput = document.createElement("input"); withInput.className = "person-input"; withInput.placeholder = "Ange annan"; withInput.style.display = person.withCustom ? "inline-block" : "none"; withInput.value = person.withCustom ? (person.withWho || "") : "";
      // Select initial value
      withSel.value = person.withCustom ? "Annan‚Ä¶" : (person.withWho || "Mamma");
      withSel.addEventListener("change", ()=>{
        if (withSel.value === "Annan‚Ä¶"){
          withInput.style.display = "inline-block";
          person.withCustom = true;
          person.withWho = withInput.value.trim();
        } else {
          withInput.style.display = "none";
          person.withCustom = false;
          person.withWho = withSel.value === "Ingen" ? "" : withSel.value;
        }
        saveState(); render();
      });
      withInput.addEventListener("input", ()=>{ person.withWho = withInput.value.trim(); saveState(); });
      controls.appendChild(withSel);
      controls.appendChild(withInput);

      // Activity dropdown + image picker under
      const actLabel = document.createElement("span"); actLabel.className = "person-meta"; actLabel.textContent = "aktivitet:";
      controls.appendChild(actLabel);
      const actSelect = document.createElement("select"); actSelect.className = "person-select";
      const actNone = document.createElement("option"); actNone.value = ""; actNone.textContent = "‚Äî"; actSelect.appendChild(actNone);
      const libSimple = LIBRARY.filter(it => ["H√§st","Dator","Spel","Lek ute","Ute","Cykla","Musik","Skola"].includes(it.text));
      for (const it of libSimple){
        const o = document.createElement("option"); o.value = it.text; o.textContent = `${it.emoji} ${it.text}`; actSelect.appendChild(o);
      }
      actSelect.value = person.withWhatText || "";
      actSelect.addEventListener("change", ()=>{
        const chosen = libSimple.find(x=>x.text===actSelect.value);
        if (chosen){ person.withWhatEmoji = chosen.emoji; person.withWhatText = chosen.text; }
        else { person.withWhatEmoji = ""; person.withWhatText = ""; }
        saveState(); render();
      });
      controls.appendChild(actSelect);

      // ETA range: start and end
      const etaStartSel = document.createElement("select"); etaStartSel.className = "person-select";
      for (const t of TIME_OPTS){ const o = document.createElement("option"); o.value = t; o.textContent = t === "" ? "Start ‚Äî" : t; if (person.etaStart===t) o.selected = true; etaStartSel.appendChild(o); }
      const etaEndSel = document.createElement("select"); etaEndSel.className = "person-select";
      for (const t of TIME_OPTS){ const o = document.createElement("option"); o.value = t; o.textContent = t === "" ? "Slut ‚Äî" : t; if (person.etaEnd===t) o.selected = true; etaEndSel.appendChild(o); }
      etaStartSel.addEventListener("change", ()=>{ person.etaStart = etaStartSel.value; saveState(); render(); });
      etaEndSel.addEventListener("change", ()=>{ person.etaEnd = etaEndSel.value; saveState(); render(); });
      controls.appendChild(etaStartSel);
      controls.appendChild(etaEndSel);

      // Delete person
      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "btn danger";
      delBtn.textContent = "üóëÔ∏è Ta bort";
      delBtn.addEventListener("click", ()=>{
        if (!confirm(`Ta bort ${person.name}?`)) return;
        if (!person.id){
          const idx = (state.people || []).indexOf(person);
          if (idx >= 0){ (state.people || []).splice(idx,1); }
        } else {
          state.people = (state.people || []).filter(p=>p.id!==person.id);
        }
        saveState();
        render();
      });
      controls.appendChild(delBtn);

      p.appendChild(controls);
    }
    pl.appendChild(p);
  }
  peopleEl.appendChild(pl);
  boardEl.appendChild(peopleEl);
  const nextId = findNextUndoneId();

  for (const slot of state.slots){
    const slotEl = document.createElement("section");
    slotEl.className = "slot";
    slotEl.dataset.slotKey = slot.key;

    const header = document.createElement("div");
    header.className = "slot-header";

    const title = document.createElement("div");
    title.className = "slot-title";
    title.textContent = slot.label;

    const sub = document.createElement("div");
    sub.className = "slot-sub";
    sub.textContent = slot.hint || "";

    header.appendChild(title);
    header.appendChild(sub);

    const actions = document.createElement("div");
    actions.className = "slot-actions";
    if (editMode){
      const addBtn = document.createElement("button");
      addBtn.className = "btn blue";
      addBtn.textContent = "Ôºã L√§gg till";
      addBtn.addEventListener("click", ()=> openAddModal(slot.key));
      actions.appendChild(addBtn);
    }
    header.appendChild(actions);
    slotEl.appendChild(header);

    const cardsEl = document.createElement("div");
    cardsEl.className = "cards";
    cardsEl.dataset.dropSlot = slot.key;

    if (slot.items.length === 0){
      const empty = document.createElement("div");
      empty.className = "empty";
      empty.textContent = editMode ? "Inga aktiviteter √§nnu. Tryck ‚ÄúL√§gg till‚Äù." : "Tomt just nu.";
      cardsEl.appendChild(empty);
    }

    for (const id of slot.items){
      const item = state.items[id];
      const card = document.createElement("button");
      card.className = "card" + (item.done ? " done" : "") + (id === nextId ? " now" : "");
      card.type = "button";
      card.dataset.itemId = id;
      card.dataset.slotKey = slot.key;
      card.draggable = editMode;

      // Click behavior
      card.addEventListener("click", () => {
        if (editMode){
          openEditModal(slot.key, id);
        } else {
          item.done = !item.done;
          saveState();
          render();
        }
      });

      // Drag behavior (only edit mode)
      if (editMode){
        card.addEventListener("dragstart", onDragStart);
        card.addEventListener("dragend", onDragEnd);
      }

      const icon = document.createElement("div");
      icon.className = "icon";
      icon.textContent = item.emoji || "üü¶";

      const txt = document.createElement("div");
      txt.className = "card-text";

      const label = document.createElement("div");
      label.className = "label";
      label.textContent = item.text;

      txt.appendChild(label);

      if (showTimes && item.time){
        const timeEl = document.createElement("div");
        timeEl.className = "time";
        timeEl.textContent = item.time;
        txt.appendChild(timeEl);
      }

      const badge = document.createElement("div");
      badge.className = "badge " + (item.done ? "done" : "");
      badge.textContent = item.done ? "KLAR" : (id===nextId ? "NU" : "");

      const handle = document.createElement("div");
      handle.className = "drag-handle";
      handle.textContent = "‚Üï dra";

      // Inline delete button in edit mode
      if (editMode){
        const del = document.createElement("button");
        del.type = "button";
        del.className = "btn danger";
        del.style.position = "absolute";
        del.style.top = "6px";
        del.style.left = "6px";
        del.style.padding = "4px 6px";
        del.style.fontSize = "12px";
        del.textContent = "üóëÔ∏è";
        del.title = "Ta bort aktivitet";
        del.addEventListener("click", (e)=>{
          e.stopPropagation();
          const s = state.slots.find(s=>s.key===slot.key);
          s.items = s.items.filter(x=>x!==id);
          delete state.items[id];
          saveState();
          render();
        });
        card.appendChild(del);
      }

      card.appendChild(icon);
      card.appendChild(txt);
      if (badge.textContent) card.appendChild(badge);
      card.appendChild(handle);

      cardsEl.appendChild(card);
    }

    // Drop zone
    if (editMode){
      cardsEl.addEventListener("dragover", onDragOver);
      cardsEl.addEventListener("drop", onDrop);
    }

    slotEl.appendChild(cardsEl);
    boardEl.appendChild(slotEl);
  }
}

function renderLibrary(){
  libraryEl.innerHTML = "";
  for (const it of LIBRARY){
    const el = document.createElement("div");
    el.className = "lib-item";
    el.tabIndex = 0;

    const emo = document.createElement("div");
    emo.className = "lib-emoji";
    emo.textContent = it.emoji;

    const lbl = document.createElement("div");
    lbl.className = "lib-label";
    lbl.textContent = it.text;

    el.appendChild(emo);
    el.appendChild(lbl);

    el.addEventListener("click", () => {
      activityEmoji.value = it.emoji;
      if (!activityText.value) activityText.value = it.text;
      highlightLibrary(it.emoji);
    });

    libraryEl.appendChild(el);
  }
}

function highlightLibrary(emoji){
  for (const child of libraryEl.children){
    child.style.borderColor = (child.querySelector(".lib-emoji").textContent === emoji)
      ? "rgba(34,197,94,0.9)"
      : "rgba(148,163,184,0.18)";
  }
}

// ----- Modal helpers -----
function openAddModal(slotKey){
  editingContext = {slotKey, itemId:null};
  modalTitle.textContent = "L√§gg till aktivitet";
  activityText.value = "";
  activityTime.value = "";
  activityEmoji.value = "";
  highlightLibrary(null);
  deleteBtn.style.display = "none";
  modalBackdrop.classList.add("show");
  activityText.focus();
}

function openEditModal(slotKey, itemId){
  editingContext = {slotKey, itemId};
  const item = state.items[itemId];
  modalTitle.textContent = "√Ñndra aktivitet";
  activityText.value = item.text || "";
  activityTime.value = item.time || "";
  activityEmoji.value = item.emoji || "";
  highlightLibrary(item.emoji);
  deleteBtn.style.display = "inline-flex";
  modalBackdrop.classList.add("show");
  activityText.focus();
}

function closeModal(){
  modalBackdrop.classList.remove("show");
  editingContext = null;
}

// Add person (inline create)
function openPeopleAddModal(){
  // create minimal new person and push
  const id = safeUUID();
  const newPerson = { id, name:"Person", status:"here", withWho:"", eta:"", withWhatEmoji:"", withWhatText:"", etaStart:"", etaEnd:"", withCustom:false };
  state.people = state.people || [];
  state.people.push(newPerson);
  saveState();
  render();
}

// ----- Drag and drop -----
let dragItemId = null;
let dragFromSlot = null;

function onDragStart(e){
  dragItemId = e.currentTarget.dataset.itemId;
  dragFromSlot = e.currentTarget.dataset.slotKey;
  e.dataTransfer.effectAllowed = "move";
  e.currentTarget.style.opacity = "0.6";
}

function onDragEnd(e){
  e.currentTarget.style.opacity = "1";
  dragItemId = null;
  dragFromSlot = null;
}

function onDragOver(e){
  e.preventDefault();
  e.dataTransfer.dropEffect = "move";
}

function onDrop(e){
  e.preventDefault();
  const toSlotKey = e.currentTarget.dataset.dropSlot;
  if (!dragItemId || !dragFromSlot) return;

  if (toSlotKey === dragFromSlot){
    // Reorder within same slot by dropping near end (simple MVP)
    // We'll move to end if same slot
    const slot = state.slots.find(s=>s.key===toSlotKey);
    slot.items = slot.items.filter(id=>id!==dragItemId);
    slot.items.push(dragItemId);
  } else {
    // Move between slots
    const fromSlot = state.slots.find(s=>s.key===dragFromSlot);
    const toSlot = state.slots.find(s=>s.key===toSlotKey);
    fromSlot.items = fromSlot.items.filter(id=>id!==dragItemId);
    toSlot.items.push(dragItemId);
  }

  saveState();
  render();
}

// ----- Logic helpers -----
function findNextUndoneId(){
  for (const slot of state.slots){
    for (const id of slot.items){
      if (!state.items[id].done) return id;
    }
  }
  return null;
}

function makeDefaultState(){
  const today = new Date();
  const id = today.toISOString().slice(0,10);
  const slots = DEFAULT_SLOTS.map(s=>({ ...s, items: [] }));
  const people = [
    { id: safeUUID(), name:"Mamma", status:"here", withWho:"", eta:"", withWhatEmoji:"", withWhatText:"", etaStart:"", etaEnd:"" },
    { id: safeUUID(), name:"Pappa", status:"later", withWho:"Mamma", eta:"18:00", withWhatEmoji:"", withWhatText:"", etaStart:"", etaEnd:"" },
    { id: safeUUID(), name:"Syskon", status:"away", withWho:"Kompis", eta:"", withWhatEmoji:"", withWhatText:"", etaStart:"", etaEnd:"" },
  ];

  // Exempel utifr√•n ditt schema (kan rensas av vuxen snabbt)
  const items = {};
  function add(slotKey, text, time, emoji){
    const id = safeUUID();
    items[id] = {id, text, time, emoji, done:false};
    slots.find(s=>s.key===slotKey).items.push(id);
  }

  add("morning", "Vakna", "", "üåÖ");
  add("morning", "Frukost", "", "üçû");
  add("morning", "Kl√§ p√• sig (innekl√§der)", "", "üëï");
  add("morning", "Borsta h√•ret", "", "üíá");
  add("morning", "Borsta t√§nderna", "", "ü™•");
  add("morning", "Kl√§ p√• sig (ytterkl√§der)", "", "üß•");
  add("morning", "√Öka till skolan", "09:30", "üöó");

  add("forenoon", "Skola", "10:00‚Äì11:00", "üè´");
  add("lunch", "Lunch", "12:00‚Äì13:00", "üç≤");
  add("afternoon", "Utomhusaktivitet", "13:00‚Äì14:00", "üå≥");
  add("afternoon", "Mellis", "14:30", "ü•™");
  add("afternoon", "Egen tid", "15:00‚Äì16:30", "üé®");

  add("evening", "Middag", "17:30", "üçù");
  add("evening", "Egen tid", "18:00", "üé≤");
  add("evening", "Kv√§llsmedicin", "19:00", "üíä");
  add("evening", "Sova", "20:00", "üò¥");

  return { id, title:"Dagsplan", slots, items, people, version:1 };
}

function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return null;
  try{ return JSON.parse(raw); }
  catch{ return null; }
}

// ----- People helpers -----
// nextStatus borttagen (dropdown-only)
function statusLabel(s){
  if (s === "here") return "‚úÖ h√§r";
  if (s === "away") return "üöó borta";
  return "‚è≥ senare";
}
</script>
</body>
</html>
